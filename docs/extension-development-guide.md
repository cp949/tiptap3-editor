# Tiptap 확장 개발 지침서

이 지침서는 `@cp949/tiptap3-editor` 프로젝트 내에서 Tiptap 확장을 개발할 때 일관성을 유지하고 성능과 안정성을 확보하기 위한 표준 가이드입니다.

---

## 1. 개요

Tiptap 확장은 에디터의 코어 기능을 확장하는 강력한 방법입니다. 우리는 **Prefixing을 통한 스타일 격리**, **SSR 호환성**, **타이핑 성능 최적화**를 최우선 가치로 삼습니다. 모든 새로운 기능은 기존의 `StarterKit`과 조화를 이루어야 하며, 사용자가 쉽게 커스터마이징할 수 있는 설정을 제공해야 합니다.

---

## 2. 반드시 지켜야 할 지침 (20 Do)

1.  **고유한 Name 부여**: 모든 확장은 충돌 방지를 위해 고유하고 명확한 `name`을 가져야 합니다.
2.  **addOptions 활용**: 사용자가 `configure()`를 통해 설정을 변경할 수 있도록 `addOptions`에 기본값을 정의하세요.
3.  **mergeAttributes 사용**: `renderHTML` 시 기본 속성과 사용자 속성을 누락 없이 합치기 위해 반드시 `mergeAttributes`를 사용하세요.
4.  **addAttributes를 통한 상태 관리**: HTML 요소에 저장되어야 하는 데이터는 `addAttributes`를 통해 선언적으로 관리하세요.
5.  **명확한 Commands 제공**: 외부에서 기능을 트리거할 수 있도록 `addCommands`에 직관적인 명령어를 추가하세요.
6.  **키보드 단축키 지원**: 접근성 향상을 위해 `addKeyboardShortcuts`를 통해 필수 기능에 대한 단축키를 제공하세요.
7.  **정밀한 parseHTML 구현**: `getAttrs`를 활용하여 원치 않는 태그가 해당 노드로 잘못 인식되지 않도록 필터링하세요.
8.  **시맨틱 HTML 렌더링**: `renderHTML` 시 문서 구조에 적합한 표준 HTML 태그를 우선적으로 사용하세요.
9.  **확장 우선순위(Priority) 고려**: 다른 확장과 겹치는 동작이 있다면 `priority` 값을 조정하여 실행 순서를 제어하세요.
10. **Input Rules 지원**: 마크다운 문법 등으로 빠르게 기능을 실행할 수 있도록 `addInputRules`를 구현하세요.
11. **Paste Rules 구현**: 외부 콘텐츠 붙여넣기 시 해당 확장이 자동으로 적용되도록 `addPasteRules`를 활용하세요.
12. **복잡한 UI는 NodeView 사용**: HTML만으로 구현하기 힘든 복잡한 인터랙션은 React 컴포넌트 기반의 `NodeView`를 활용하세요.
13. **Prefixing 규칙 준수**: 스타일에 사용하는 클래스명은 반드시 `te-` 프리픽스를 붙여 외부 환경과 격리하세요.
14. **TypeScript 타입 정의**: 모든 옵션과 속성에 대해 명확한 타입을 정의하여 개발자 경험을 개선하세요.
15. **SSR 호환성 확보**: `immediatelyRender: false` 옵션을 고려하고, 브라우저 전용 API 사용 시 체크 로직을 넣으세요.
16. **명령어 체이닝(Chaining) 지원**: 명령어가 다른 명령어와 연결될 수 있도록 `({ commands }) => { ... }` 패턴을 준수하세요.
17. **에디터 인스턴스 접근 시 안전성 확보**: `this.editor` 접근 시 에디터가 파괴된 상태인지 확인하는 로직을 고려하세요.
18. **이벤트 핸들러 최적화**: `onTransaction`, `onUpdate` 등 빈번한 이벤트에는 쓰로틀링이나 디바운싱을 검토하세요.
19. **기존 확장 확장하기(Extension.extend)**: 처음부터 만들기보다 기존 확장을 `extend`하여 재사용성을 높이세요.
20. **문서화**: 새로운 확장을 추가한 후에는 `docs` 및 `README.md`에 사용법을 업데이트하세요.

---

## 3. 반드시 하지 말아야 할 지침 (20 Don't)

1.  **직접적인 DOM 조작**: `document.getElementById` 등 에디터 영역 밖의 DOM을 직접 수정하지 마세요. (React/Tiptap API 활용)
2.  **글로벌 CSS 사용**: 프리픽스 없는 스타일 클래스를 사용하여 외부 라이브러리와 충돌을 일으키지 마세요.
3.  **무거운 연산 동기 실행**: `onUpdate` 등에서 복잡한 계산을 수행하여 타이핑 성능을 저하시키지 마세요.
4.  **로컬 변수에 상태 저장**: 노드나 마크의 상태를 확장의 로컬 변수에 저장하지 마세요. (문서 상태와 동기화되지 않음)
5.  **광범위한 Tag 매칭**: `parseHTML`에서 너무 흔한 태그(예: `div`)를 속성 체크 없이 무조건 가로채지 마세요.
6.  **시스템 단축키 덮어쓰기**: 브라우저나 OS의 기본 단축키(예: `Cmd+C`, `Cmd+V`)를 가급적 변경하지 마세요.
7.  **transaction 없는 문서 수정**: 에디터 상태를 변경할 때는 항상 `tr`(Transaction)을 거쳐야 합니다. 강제 조작은 히스토리를 파괴합니다.
8.  **불필요한 NodeView 생성**: 단순한 스타일 적용은 `Mark`나 기본 `renderHTML`로 처리하세요. 가급적 성능을 위해 `NodeView`는 최소화합니다.
9.  **Storage 남용**: `this.storage`에 너무 크거나 무거운 객체를 담지 마세요.
10. **하드코딩된 스타일**: 색상이나 크기를 코드에 직접 쓰지 말고 `addOptions`나 CSS 변수를 통해 주입받으세요.
11. **mergeAttributes 누락**: 레퍼런스 속성을 무시하고 새 속성객체로만 덮어씌우면 클래스명 등이 소실됩니다.
12. **외부 라이브러리 직접 의존**: 가능하면 Tiptap 내장 라이브러리(`@tiptap/pm/*`)를 우선 활용하여 번들 크기를 관리하세요.
13. **브라우저 객체(window, document) 무방비 사용**: SSR 환경에서 빌드 에러를 유발하므로 항상 존재 여부를 체크하세요.
14. **무한 루프 유발 컨텐츠 설정**: `Node`의 `content`를 정의할 때 자기 자신을 무한히 포함할 수 있는 구조를 피하세요.
15. **검증 없는 속성 입력**: 사용자로부터 받는 속성값에 대해 기본적인 유효성 검사 없이 바로 렌더링하지 마세요.
16. **중복 명령어 이름 부착**: 다른 확장과 겹치는 명령어 이름은 예기치 못한 동작을 유발합니다.
17. **비효율적인 정규식 사용**: `addInputRules` 등에서 백트래킹이 심한 무거운 정규식을 피하세요.
18. **Cleanup 누락**: `addProseMirrorPlugins` 내에서 외부 리스너를 등록했다면 `destroy` 시점에 반드시 해제하세요.
19. **내부 API 과도한 노출**: Tiptap의 불안정한 내부 API에 직접 의존하여 버전 업그레이드를 어렵게 만들지 마세요.
20. **테스트 없이 배포**: 복잡한 로직을 가진 확장은 최소한의 렌더링 테스트 없이 통합하지 마세요.
